---
- hosts: all:!ad
  become: true
  become_method: sudo
  tasks:
    - name: Check for RHSM certificate
      stat:
        path: /etc/pki/consumer/cert.pem
      register: rhsm_cert

    - name: Check for Insights
      stat:
        path: /var/lib/insights/host-details.json
      register: insights_host
      when: rhsm_cert.stat.exists == true

    - name: Unregister host from Insights Inventory
      shell: "insights-client --unregister"
      when: >
        rhsm_cert.stat.exists == true
        and insights_host.stat.exists
        and ansible_distribution_major_version == '7'

    - name: Disconnect host from RHSM and RHC
      shell: "rhc disconnect"
      when: rhsm_cert.stat.exists == true

[tox]
envlist = py,py36,ruff,format,mypy,jslint,yamllint,pylint,rpkg,maketest,cov

[testenv]
passenv = HOME
skipsdist = true
skip_install = true
deps =
    # ipaclient  # installed from global
    requests
    coverage[toml]
    dbus-python
    pygobject
commands =
    {envpython} -m compileall -q \
      tests/ \
      ipahcc/ \
      ipahcc_auto_enrollment.py \
      ipaserver/
    {envpython} -Wignore -m coverage run -m unittest discover -v -s {posargs} tests/

[testenv:py]
# load ipaclient, ipaserver from global site-packages
sitepackages = true
deps =
    {[testenv]deps}
    jsonschema 

[testenv:py36]
sitepackages = true
deps =
    ipaclient
    {[testenv]deps}
    # register_interface
    cryptography < 38.0
    jsonschema < 3.0

[testenv:cov]
depends = py,py36
deps =
    coverage[toml]
commands =
    {envpython} -m coverage combine
    {envpython} -m coverage html
    {envpython} -m coverage report

[testenv:ruff]
skipsdist = true
deps =
   ruff
commands =
    ruff check .

[testenv:pylint]
sitepackages = true
deps =
    pylint
commands =
    {envpython} -m pylint \
        ipahcc \
        ipahcc_auto_enrollment.py \
        ipaserver/install/plugins/update_hcc_enrollment_service.py \
        ipaserver/install/plugins/update_hcc.py \
        ipaserver/plugins/hccconfig.py \
        ipaserver/plugins/hcchost.py \
        ipaserver/plugins/hccserverroles.py \
        tests/conftest.py \
        tests/test_autoenrollment.py \
        tests/test_hccapi.py \
        tests/test_mockapi.py \
        tests/test_registration.py \
        tests/tests.py

[testenv:format]
deps = black
commands =
    black --check --diff {posargs:.}

[testenv:jslint]
deps =
changedir = {envdir}
whitelist_externals = npm
commands =
    npm install --silent eslint@latest
    {envdir}/node_modules/.bin/eslint \
        -c {toxinidir}/.eslintrc.json \
        {toxinidir}/install/server/ui/js/

[testenv:yamllint]
deps = yamllint
changedir = {envdir}
commands =
    {envpython} -m yamllint --strict .

[testenv:rpkg]
deps = {[testenv:py]deps}
skipsdist = true
whitelist_externals = make
commands =
    make _rpkg

[testenv:maketest]
deps =
skipsdist = true
whitelist_externals = make
commands =
    make test

[testenv:mypy]
sitepackages = true
skipsdist = true
deps =
   {[testenv]deps}
   mypy >= 1.2.0
   types-jsonschema
   types-requests
   types-setuptools
commands =
    {envpython} -m mypy ipahcc ipahcc_auto_enrollment.py ipaserver
